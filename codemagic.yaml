workflows:
  ios-build:
    name: Solana iOS Build (–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
    instance_type: mac_mini_m2
    max_build_duration: 120
    
    environment:
      groups:
        - telegram_credentials
      vars:
        BUNDLE_ID: "com.solana.messenger"
      xcode: latest
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: main
          include: true
          source: true
    
    scripts:
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        script: |
          brew install python@3.11 bazelisk yasm
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:$PATH"
          
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram API
        script: |
          mkdir -p build-input
          cat > build-input/build-configuration.json << EOF
          {
            "bundle_id": "com.solana.messenger",
            "api_id": "${TELEGRAM_API_ID}",
            "api_hash": "${TELEGRAM_API_HASH}",
            "team_id": "FAKETEAM01",
            "app_center_id": "",
            "is_internal_build": true,
            "is_appstore_build": false,
            "appstore_id": "",
            "app_specific_url_scheme": "solana",
            "premium_iap_product_id": "org.solana.premium",
            "enable_siri": false,
            "enable_icloud": false,
            "google_client_scheme": "",
            "ng_env": "production"
          }
          EOF
          
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ldid (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Saurik –¥–ª—è –ø–æ–¥–ø–∏—Å–∏)
        script: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ldid - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è Cydia
          brew install ldid
          
      - name: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–µ–π–∫–æ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –∏ entitlements
        script: |
          mkdir -p fake-codesigning
          
          # –°–æ–∑–¥–∞—ë–º entitlements –¥–ª—è ad-hoc –ø–æ–¥–ø–∏—Å–∏
          cat > fake-codesigning/entitlements.plist << 'ENTITLEMENTS'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>application-identifier</key>
              <string>*</string>
              <key>get-task-allow</key>
              <true/>
          </dict>
          </plist>
          ENTITLEMENTS
          
          # –°–æ–∑–¥–∞—ë–º —Ñ–µ–π–∫–æ–≤—ã–π provisioning profile
          cat > fake-codesigning/Solana.mobileprovision << 'PROFILE'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>AppIDName</key>
              <string>Solana Messenger</string>
              <key>Entitlements</key>
              <dict>
                  <key>aps-environment</key>
                  <string>development</string>
                  <key>application-identifier</key>
                  <string>FAKETEAM01.com.solana.messenger</string>
                  <key>get-task-allow</key>
                  <true/>
              </dict>
              <key>Name</key>
              <string>Solana Development</string>
              <key>TeamIdentifier</key>
              <array>
                  <string>FAKETEAM01</string>
              </array>
              <key>UUID</key>
              <string>00000000-0000-0000-0000-000000000001</string>
          </dict>
          </plist>
          PROFILE
          
      - name: –°–±–æ—Ä–∫–∞ –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
        script: |
          python3 build-system/Make/Make.py \
            --cacheDir="$HOME/bazel-cache" \
            build \
            --configurationPath="build-input/build-configuration.json" \
            --codesigningInformationPath="fake-codesigning" \
            --buildNumber=1 \
            --configuration=release_sim_arm64

      - name: –°–æ–∑–¥–∞–Ω–∏–µ IPA –∏ –ø–æ–¥–ø–∏—Å—å —á–µ—Ä–µ–∑ ldid
        script: |
          mkdir -p output
          APP_PATH=$(find bazel-bin -name "*.app" -type d | head -1)
          
          if [ -n "$APP_PATH" ]; then
            echo "–ù–∞–π–¥–µ–Ω .app: $APP_PATH"
            
            # –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            cp -R "$APP_PATH" output/Telegram.app
            
            # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ ldid (–º–µ—Ç–æ–¥ Saurik)
            echo "–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ ldid..."
            ldid -Sfake-codesigning/entitlements.plist output/Telegram.app/Telegram
            
            # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏
            find output/Telegram.app/Frameworks -name "*.framework" -type d | while read framework; do
              binary=$(basename "$framework" .framework)
              if [ -f "$framework/$binary" ]; then
                ldid -S "$framework/$binary"
              fi
            done
            
            # –°–æ–∑–¥–∞—ë–º IPA
            cd output
            mkdir -p Payload
            mv Telegram.app Payload/
            zip -r Solana-ldid-signed.ipa Payload
            cp Solana-ldid-signed.ipa $CM_EXPORT_DIR/
            
            echo "‚úÖ IPA —Å–æ–∑–¥–∞–Ω —Å ldid –ø–æ–¥–ø–∏—Å—å—é!"
            echo "üì± –≠—Ç–æ—Ç IPA –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ AltStore"
          else
            echo "‚ùå .app –Ω–µ –Ω–∞–π–¥–µ–Ω"
            find bazel-bin -name "*.app" -o -name "*.ipa" 2>/dev/null > $CM_EXPORT_DIR/search-results.txt
          fi
          
    artifacts:
      - output/*.ipa
      - $CM_EXPORT_DIR/*.ipa
      - $CM_EXPORT_DIR/*.txt
      
    publishing:
      scripts:
        - name: –ì–æ—Ç–æ–≤–æ
          script: |
            echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
            echo "üì± IPA –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ —Å–æ–∑–¥–∞–Ω"
            echo "‚ö†Ô∏è –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ AltStore"