workflows:
  ios-build:
    name: Solana iOS Build (Xcode Managed)
    instance_type: mac_mini_m2
    max_build_duration: 120
    
    environment:
      groups:
        - telegram_credentials
      vars:
        BUNDLE_ID: "com.solana.messenger"
      xcode: latest
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: main
          include: true
          source: true
    
    scripts:
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        script: |
          brew install python@3.11 bazelisk yasm
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:$PATH"
          
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram API
        script: |
          mkdir -p build-input
          cat > build-input/build-configuration.json << EOF
          {
            "bundle_id": "com.solana.messenger",
            "api_id": "${TELEGRAM_API_ID}",
            "api_hash": "${TELEGRAM_API_HASH}",
            "team_id": "",
            "app_center_id": "",
            "is_internal_build": true,
            "is_appstore_build": false,
            "appstore_id": "",
            "app_specific_url_scheme": "solana",
            "premium_iap_product_id": "org.solana.premium",
            "enable_siri": false,
            "enable_icloud": false,
            "google_client_scheme": "",
            "ng_env": "production"
          }
          EOF
          
      - name: –°–±–æ—Ä–∫–∞ –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ —Å Xcode Managed Codesigning
        script: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Xcode Managed Codesigning - –ù–ï —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π!
          python3 build-system/Make/Make.py \
            --cacheDir="$HOME/bazel-cache" \
            build \
            --configurationPath="build-input/build-configuration.json" \
            --xcodeManagedCodesigning \
            --buildNumber=1 \
            --configuration=release_sim_arm64

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ldid –∏ —Å–æ–∑–¥–∞–Ω–∏–µ IPA
        script: |
          brew install ldid
          mkdir -p output
          
          # –ù–∞—Ö–æ–¥–∏–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π .app
          APP_PATH=$(find bazel-bin -name "*.app" -type d | head -1)
          
          if [ -n "$APP_PATH" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω .app: $APP_PATH"
            
            # –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            cp -R "$APP_PATH" output/Telegram.app
            
            # –°–æ–∑–¥–∞—ë–º entitlements
            cat > output/entitlements.plist << 'ENTITLEMENTS'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>get-task-allow</key>
              <true/>
          </dict>
          </plist>
          ENTITLEMENTS
            
            # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ ldid
            echo "–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ ldid..."
            ldid -Soutput/entitlements.plist output/Telegram.app/Telegram
            
            # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            find output/Telegram.app -type f -perm +111 | while read binary; do
              if file "$binary" | grep -q "Mach-O"; then
                echo "–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º: $binary"
                ldid -S "$binary" 2>/dev/null || true
              fi
            done
            
            # –°–æ–∑–¥–∞—ë–º IPA
            cd output
            mkdir -p Payload
            mv Telegram.app Payload/
            zip -r Solana-Messenger.ipa Payload
            cp Solana-Messenger.ipa $CM_EXPORT_DIR/
            
            echo "‚úÖ IPA —Å–æ–∑–¥–∞–Ω: Solana-Messenger.ipa"
            echo "üì± –£—Å—Ç–∞–Ω–æ–≤–∏ —á–µ—Ä–µ–∑ TrollStore –∏–ª–∏ AltStore"
          else
            echo "‚ùå .app –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "–ü–æ–∏—Å–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤..."
            find bazel-bin -name "*.app" -o -name "*.ipa" 2>/dev/null || echo "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          fi
          
    artifacts:
      - output/*.ipa
      - $CM_EXPORT_DIR/*.ipa
      - $CM_EXPORT_DIR/*.txt
      
    publishing:
      scripts:
        - name: –ì–æ—Ç–æ–≤–æ
          script: |
            echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
            echo "üì± IPA –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ —Å–æ–∑–¥–∞–Ω"
            echo "‚ö†Ô∏è –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ AltStore"