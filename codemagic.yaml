workflows:
  ios-build:
    name: Solana iOS Build (–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
    instance_type: mac_mini_m2
    max_build_duration: 120
    
    environment:
      groups:
        - telegram_credentials
      vars:
        BUNDLE_ID: "com.solana.messenger"
      xcode: latest
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: main
          include: true
          source: true
    
    scripts:
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        script: |
          brew install python@3.11 bazelisk yasm
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:$PATH"
          
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram API
        script: |
          mkdir -p build-input
          cat > build-input/build-configuration.json << EOF
          {
            "bundle_id": "com.solana.messenger",
            "api_id": "${TELEGRAM_API_ID}",
            "api_hash": "${TELEGRAM_API_HASH}",
            "team_id": "FAKETEAM01",
            "app_center_id": "",
            "is_internal_build": true,
            "is_appstore_build": false,
            "appstore_id": "",
            "app_specific_url_scheme": "solana"
          }
          EOF
          
      - name: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–µ–π–∫–æ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–¥–ø–∏—Å–∏
        script: |
          # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å —Ñ–µ–π–∫–æ–≤—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
          mkdir -p fake-codesigning
          
          # –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π plist –ø—Ä–æ—Ñ–∏–ª—å (–Ω–µ –≤–∞–ª–∏–¥–Ω—ã–π, –Ω–æ –ø—Ä–æ–π–¥—ë—Ç –ø–∞—Ä—Å–∏–Ω–≥)
          cat > fake-codesigning/Solana.mobileprovision << 'PROFILE'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>AppIDName</key>
              <string>Solana Messenger</string>
              <key>Entitlements</key>
              <dict>
                  <key>aps-environment</key>
                  <string>development</string>
                  <key>application-identifier</key>
                  <string>FAKETEAM01.com.solana.messenger</string>
              </dict>
              <key>Name</key>
              <string>Solana Development</string>
              <key>TeamIdentifier</key>
              <array>
                  <string>FAKETEAM01</string>
              </array>
              <key>UUID</key>
              <string>00000000-0000-0000-0000-000000000001</string>
          </dict>
          </plist>
          PROFILE
          
      - name: –°–±–æ—Ä–∫–∞ –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
        script: |
          # –°–±–æ—Ä–∫–∞ –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∏!
          python3 build-system/Make/Make.py \
            --cacheDir="$HOME/bazel-cache" \
            build \
            --configurationPath="build-input/build-configuration.json" \
            --codesigningInformationPath="fake-codesigning" \
            --buildNumber=1 \
            --configuration=release_sim_arm64

      - name: –°–æ–∑–¥–∞–Ω–∏–µ IPA –∏–∑ —Å–∏–º—É–ª—è—Ç–æ—Ä–Ω–æ–π —Å–±–æ—Ä–∫–∏
        script: |
          mkdir -p output
          # –ù–∞—Ö–æ–¥–∏–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π .app
          APP_PATH=$(find bazel-bin -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            cp -R "$APP_PATH" output/
            cd output
            mkdir -p Payload
            mv *.app Payload/
            zip -r Solana-unsigned.ipa Payload
            cp Solana-unsigned.ipa $CM_EXPORT_DIR/
            echo "‚úÖ IPA —Å–æ–∑–¥–∞–Ω: Solana-unsigned.ipa"
          else
            echo "‚ö†Ô∏è .app –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç"
            echo "Build completed but no .app found" > $CM_EXPORT_DIR/build-log.txt
          fi
          
    artifacts:
      - output/*.ipa
      - $CM_EXPORT_DIR/*.ipa
      - $CM_EXPORT_DIR/*.txt
      
    publishing:
      scripts:
        - name: –ì–æ—Ç–æ–≤–æ
          script: |
            echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
            echo "üì± IPA –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ —Å–æ–∑–¥–∞–Ω"
            echo "‚ö†Ô∏è –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ AltStore"