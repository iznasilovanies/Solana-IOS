workflows:
  ios-build:
    name: Solana iOS Build (–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
    instance_type: mac_mini_m2
    max_build_duration: 120
    
    environment:
      groups:
        - telegram_credentials
      vars:
        BUNDLE_ID: "com.nicegram.app"
      xcode: latest
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: main
          include: true
          source: true
    
    scripts:
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        script: |
          brew install python@3.11 bazelisk yasm
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:$PATH"
          
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram API
        script: |
          mkdir -p build-input
          cat > build-input/build-configuration.json << EOF
          {
            "bundle_id": "com.nicegram.app",
            "api_id": "${TELEGRAM_API_ID}",
            "api_hash": "${TELEGRAM_API_HASH}",
            "team_id": "",
            "app_center_id": "",
            "is_internal_build": true,
            "is_appstore_build": false,
            "appstore_id": "",
            "app_specific_url_scheme": "tg"
          }
          EOF
          
      - name: –°–±–æ—Ä–∫–∞ iOS –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
        script: |
          # –°–±–æ—Ä–∫–∞ –±–µ–∑ code signing
          python3 build-system/Make/Make.py \
            --cacheDir="$HOME/bazel-cache" \
            build \
            --configurationPath="build-input/build-configuration.json" \
            --buildNumber=1 \
            --configuration=release_arm64 \
            --disableCodeSigning

      - name: –°–æ–∑–¥–∞–Ω–∏–µ IPA
        script: |
          # –°–æ–∑–¥–∞—ë–º –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π IPA
          mkdir -p output
          find . -name "*.app" -type d | head -1 | xargs -I {} cp -R {} output/
          cd output
          mkdir Payload
          mv *.app Payload/ 2>/dev/null || true
          zip -r Solana-unsigned.ipa Payload
          cp Solana-unsigned.ipa $CM_EXPORT_DIR/
          
    artifacts:
      - output/*.ipa
      - $CM_EXPORT_DIR/*.ipa
      
    publishing:
      scripts:
        - name: –ì–æ—Ç–æ–≤–æ
          script: |
            echo "‚úÖ –ù–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π IPA –≥–æ—Ç–æ–≤!"
            echo "üì± –£—Å—Ç–∞–Ω–æ–≤–∏ —á–µ—Ä–µ–∑ AltStore —Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º Apple ID"